# Telegram Polling æ¨¡å¼ä½¿ç”¨æŒ‡å—

## æ¦‚è¿°

Telegram Pollingæ¨¡å¼æ˜¯webhookçš„æ›¿ä»£æ–¹æ¡ˆï¼Œé€šè¿‡å®šæœŸè½®è¯¢Telegram APIæ¥è·å–ç”¨æˆ·çš„åˆ†é¡µæŒ‰é’®ç‚¹å‡»äº‹ä»¶ã€‚è¿™ç§æ–¹å¼æ— éœ€è®¾ç½®å¤–éƒ¨æœåŠ¡å™¨ï¼Œé€‚åˆä¸ªäººéƒ¨ç½²å’Œæœ¬åœ°å¼€å‘ã€‚

## ä¼˜åŠ¿å¯¹æ¯”

| ç‰¹æ€§ | Pollingæ¨¡å¼ | Webhookæ¨¡å¼ |
|------|-------------|-------------|
| éƒ¨ç½²å¤æ‚åº¦ | â­ ç®€å• | â­â­â­ å¤æ‚ |
| æœåŠ¡å™¨è¦æ±‚ | æ— éœ€å¤–éƒ¨æœåŠ¡å™¨ | éœ€è¦HTTPSæœåŠ¡å™¨ |
| é˜²ç«å¢™å‹å¥½ | âœ… ä»…å‡ºç«™è¯·æ±‚ | âŒ éœ€è¦å¼€æ”¾ç«¯å£ |
| å®æ—¶æ€§ | â­â­ 1-10ç§’å»¶è¿Ÿ | â­â­â­ å³æ—¶å“åº” |
| èµ„æºæ¶ˆè€— | â­â­ å®šæœŸAPIè°ƒç”¨ | â­â­â­ ä½æ¶ˆè€— |
| è°ƒè¯•éš¾åº¦ | â­ å®¹æ˜“è°ƒè¯• | â­â­ è¾ƒéš¾è°ƒè¯• |

## é…ç½®è¯´æ˜

åœ¨ `config/config.yaml` ä¸­é…ç½®pollingæ¨¡å¼ï¼š

```yaml
notification:
  telegram_pagination:
    enabled: true # å¯ç”¨åˆ†é¡µåŠŸèƒ½
    session_ttl_hours: 1 # åˆ†é¡µä¼šè¯è¿‡æœŸæ—¶é—´
    max_pages: 20 # æœ€å¤§åˆ†é¡µæ•°é‡
    
    # Polling é…ç½®
    use_polling: true # ä½¿ç”¨pollingæ¨¡å¼
    polling_interval: 2 # è½®è¯¢é—´éš”ï¼ˆç§’ï¼‰
    long_polling_timeout: 10 # é•¿è½®è¯¢è¶…æ—¶ï¼ˆç§’ï¼‰
    auto_start_polling: false # è‡ªåŠ¨å¯åŠ¨polling
```

### é…ç½®é¡¹è¯¦è§£

- **use_polling**: é€‰æ‹©pollingè¿˜æ˜¯webhookæ¨¡å¼
- **polling_interval**: çŸ­è½®è¯¢é—´éš”ï¼Œä»…åœ¨é•¿è½®è¯¢è¶…æ—¶ä¸º0æ—¶ç”Ÿæ•ˆ
- **long_polling_timeout**: é•¿è½®è¯¢è¶…æ—¶æ—¶é—´ï¼Œæ¨è5-30ç§’ï¼Œ0è¡¨ç¤ºä½¿ç”¨çŸ­è½®è¯¢
- **auto_start_polling**: å‘é€åˆ†é¡µæ¶ˆæ¯åè‡ªåŠ¨å¯åŠ¨pollingï¼ˆå®éªŒæ€§ï¼‰

## ä½¿ç”¨æ–¹å¼

### æ–¹å¼ä¸€ï¼šç‹¬ç«‹pollingå®ˆæŠ¤è¿›ç¨‹ï¼ˆæ¨èï¼‰

ä½¿ç”¨ç‹¬ç«‹çš„pollingè„šæœ¬ï¼Œæœ€ç¨³å®šå¯é ï¼š

```bash
# åŸºæœ¬ä½¿ç”¨ï¼ˆä½¿ç”¨é…ç½®æ–‡ä»¶ä¸­çš„è®¾ç½®ï¼‰
python telegram_polling_daemon.py

# æŒ‡å®šBot Token
python telegram_polling_daemon.py --token YOUR_BOT_TOKEN

# ä½¿ç”¨ä»£ç†
python telegram_polling_daemon.py --proxy http://127.0.0.1:10086

# æŸ¥çœ‹å¸®åŠ©
python telegram_polling_daemon.py --help
```

**è¿è¡Œæ•ˆæœï¼š**
```
ğŸš€ Telegram Polling å®ˆæŠ¤è¿›ç¨‹å¯åŠ¨
ğŸ“‹ é…ç½®ä¿¡æ¯:
   Bot Token: 123456789:...
   ä»£ç†è®¾ç½®: æ— 
   è½®è¯¢é—´éš”: 2ç§’
   é•¿è½®è¯¢è¶…æ—¶: 10ç§’
ğŸ“ æ—¥å¿—:
å¼€å§‹Telegramè½®è¯¢æœåŠ¡ï¼ŒBot Token: 123456789:...
```

### æ–¹å¼äºŒï¼šé›†æˆåˆ°ä¸»ç¨‹åº

åœ¨è¿è¡Œä¸»ç¨‹åºæ—¶åŒæ—¶å¯åŠ¨pollingï¼š

```bash
# è¿è¡Œåˆ†æåå¯åŠ¨pollingæœåŠ¡
python main.py --start-polling

# ä»…å¯åŠ¨pollingæœåŠ¡ï¼ˆä¸è¿è¡Œæ–°é—»åˆ†æï¼‰
python main.py --polling-only

# æŒ‡å®šBot Token
python main.py --start-polling --bot-token YOUR_TOKEN
```

### æ–¹å¼ä¸‰ï¼šç¨‹åºå†…è‡ªåŠ¨å¯åŠ¨ï¼ˆå®éªŒæ€§ï¼‰

åœ¨é…ç½®ä¸­è®¾ç½® `auto_start_polling: true`ï¼Œåˆ†é¡µæ¶ˆæ¯å‘é€åè‡ªåŠ¨å¯åŠ¨pollingçº¿ç¨‹ã€‚

## å·¥ä½œæµç¨‹

```mermaid
graph TD
    A[å‘é€åˆ†é¡µæ¶ˆæ¯] --> B[ä¿å­˜åˆ†é¡µçŠ¶æ€]
    B --> C[å¯åŠ¨PollingæœåŠ¡]
    C --> D[è°ƒç”¨getUpdates API]
    D --> E{æœ‰æ–°çš„å›è°ƒ?}
    E -->|æ˜¯| F[å¤„ç†åˆ†é¡µæŒ‰é’®ç‚¹å‡»]
    E -->|å¦| G[ç­‰å¾…è½®è¯¢é—´éš”]
    F --> H[æ›´æ–°æ¶ˆæ¯å†…å®¹]
    H --> I[æ›´æ–°åˆ†é¡µçŠ¶æ€]
    I --> D
    G --> D
```

## æŠ€æœ¯ç»†èŠ‚

### é•¿è½®è¯¢ vs çŸ­è½®è¯¢

**é•¿è½®è¯¢ï¼ˆæ¨èï¼‰ï¼š**
- è®¾ç½® `long_polling_timeout: 10`
- APIè¯·æ±‚ä¼šç­‰å¾…10ç§’æˆ–ç›´åˆ°æœ‰æ–°æ¶ˆæ¯
- å‡å°‘APIè°ƒç”¨æ¬¡æ•°ï¼Œæé«˜æ•ˆç‡
- å“åº”æ›´åŠæ—¶

**çŸ­è½®è¯¢ï¼š**
- è®¾ç½® `long_polling_timeout: 0`
- æ¯éš” `polling_interval` ç§’è°ƒç”¨ä¸€æ¬¡API
- APIè°ƒç”¨é¢‘ç¹ï¼Œä½†æ›´å¯æ§
- é€‚åˆè°ƒè¯•å’Œæµ‹è¯•

### é”™è¯¯å¤„ç†

PollingæœåŠ¡å…·æœ‰å®Œå–„çš„é”™è¯¯å¤„ç†æœºåˆ¶ï¼š

- **ç½‘ç»œé”™è¯¯**: è‡ªåŠ¨é‡è¯•ï¼Œç­‰å¾…5ç§’åç»§ç»­
- **APIé”™è¯¯**: è®°å½•é”™è¯¯ä¿¡æ¯ï¼Œç»§ç»­è¿è¡Œ
- **è¶…æ—¶**: æ­£å¸¸ç°è±¡ï¼Œç»§ç»­ä¸‹æ¬¡è½®è¯¢
- **ä¸­æ–­ä¿¡å·**: ä¼˜é›…åœæ­¢æœåŠ¡

### æ€§èƒ½ä¼˜åŒ–

- **offsetç®¡ç†**: é¿å…é‡å¤å¤„ç†ç›¸åŒçš„æ›´æ–°
- **è¿‡æ»¤æ›´æ–°**: åªæ¥æ”¶callback_queryç±»å‹çš„æ›´æ–°
- **åˆç†é—´éš”**: å¹³è¡¡å®æ—¶æ€§å’ŒAPIä½¿ç”¨é‡

## ä½¿ç”¨åœºæ™¯

### ä¸ªäººå¼€å‘è€…

```bash
# å¼€å‘é˜¶æ®µï¼šä½¿ç”¨polling daemonæ–¹ä¾¿è°ƒè¯•
python telegram_polling_daemon.py --verbose

# ç”Ÿäº§éƒ¨ç½²ï¼šä½¿ç”¨systemdç­‰ç®¡ç†pollingæœåŠ¡
```

### æœåŠ¡å™¨éƒ¨ç½²

```bash
# æ–¹æ¡ˆ1ï¼šå•ç‹¬è¿è¡ŒpollingæœåŠ¡
nohup python telegram_polling_daemon.py > polling.log 2>&1 &

# æ–¹æ¡ˆ2ï¼šé›†æˆåˆ°ä¸»ç¨‹åº
python main.py --start-polling
```

### Dockeréƒ¨ç½²

åœ¨Dockerfileä¸­æ·»åŠ pollingæœåŠ¡ï¼š

```dockerfile
# å¯åŠ¨è„šæœ¬åŒæ—¶è¿è¡Œä¸»ç¨‹åºå’Œpolling
CMD ["bash", "-c", "python main.py && python telegram_polling_daemon.py"]
```

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **Bot Tokenæ— æ•ˆ**
   ```
   âŒ è·å–æ›´æ–°å¤±è´¥: Unauthorized
   ```
   æ£€æŸ¥Bot Tokenæ˜¯å¦æ­£ç¡®é…ç½®

2. **ç½‘ç»œè¿æ¥é—®é¢˜**
   ```
   âŒ è·å–æ›´æ–°å‡ºé”™: Connection timeout
   ```
   æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–é…ç½®ä»£ç†

3. **åˆ†é¡µçŠ¶æ€è¿‡æœŸ**
   ```
   âš ï¸ åˆ†é¡µä¼šè¯å·²è¿‡æœŸï¼Œè¯·é‡æ–°è·å–æ•°æ®
   ```
   ç”¨æˆ·éœ€è¦é‡æ–°è¿è¡Œä¸»ç¨‹åºè·å–æ–°çš„åˆ†é¡µæ¶ˆæ¯

4. **APIé¢‘ç‡é™åˆ¶**
   ```
   âŒ è·å–æ›´æ–°å¤±è´¥: Too Many Requests
   ```
   å¢åŠ è½®è¯¢é—´éš”æˆ–ä½¿ç”¨é•¿è½®è¯¢

### è°ƒè¯•æŠ€å·§

1. **å¯ç”¨è¯¦ç»†æ—¥å¿—**ï¼š
   ```bash
   python telegram_polling_daemon.py --verbose
   ```

2. **æ£€æŸ¥åˆ†é¡µçŠ¶æ€**ï¼š
   æŸ¥çœ‹ `output/.pagination_states/` ç›®å½•ä¸­çš„çŠ¶æ€æ–‡ä»¶

3. **æµ‹è¯•APIè¿æ¥**ï¼š
   ```bash
   curl "https://api.telegram.org/bot<TOKEN>/getMe"
   ```

4. **ç›‘æ§pollingçŠ¶æ€**ï¼š
   ```python
   from main import get_polling_status
   print(get_polling_status())
   ```

## æœ€ä½³å®è·µ

### ç”Ÿäº§ç¯å¢ƒ

1. **ä½¿ç”¨é•¿è½®è¯¢**: è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´ï¼ˆ5-30ç§’ï¼‰
2. **ç›‘æ§æœåŠ¡**: ä½¿ç”¨systemdã€supervisorç­‰ç®¡ç†pollingè¿›ç¨‹
3. **æ—¥å¿—ç®¡ç†**: é…ç½®æ—¥å¿—è½®è½¬ï¼Œé¿å…æ—¥å¿—æ–‡ä»¶è¿‡å¤§
4. **é”™è¯¯å‘Šè­¦**: ç›‘æ§pollingæœåŠ¡çŠ¶æ€ï¼Œå¼‚å¸¸æ—¶åŠæ—¶å‘Šè­¦

### å¼€å‘ç¯å¢ƒ

1. **ä½¿ç”¨çŸ­è½®è¯¢**: ä¾¿äºè°ƒè¯•å’Œæµ‹è¯•
2. **è¯¦ç»†æ—¥å¿—**: å¯ç”¨verboseæ¨¡å¼æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
3. **å¿«é€Ÿé‡å¯**: ä½¿ç”¨ç‹¬ç«‹çš„polling daemonä¾¿äºè°ƒè¯•

### é…ç½®å»ºè®®

```yaml
# ç”Ÿäº§ç¯å¢ƒé…ç½®
telegram_pagination:
  enabled: true
  use_polling: true
  polling_interval: 3
  long_polling_timeout: 20
  auto_start_polling: false

# å¼€å‘ç¯å¢ƒé…ç½®  
telegram_pagination:
  enabled: true
  use_polling: true
  polling_interval: 1
  long_polling_timeout: 5
  auto_start_polling: true
```

## ä¸Webhookå¯¹æ¯”

é€‰æ‹©pollingè¿˜æ˜¯webhookå–å†³äºä½ çš„éƒ¨ç½²ç¯å¢ƒï¼š

**é€‰æ‹©Pollingçš„åœºæ™¯ï¼š**
- ä¸ªäººå¼€å‘å’Œæµ‹è¯•
- æ— æ³•è®¾ç½®HTTPSæœåŠ¡å™¨
- é˜²ç«å¢™é™åˆ¶ä¸¥æ ¼
- å¸Œæœ›ç®€åŒ–éƒ¨ç½²æµç¨‹

**é€‰æ‹©Webhookçš„åœºæ™¯ï¼š**
- ç”Ÿäº§ç¯å¢ƒï¼Œå¯¹å®æ—¶æ€§è¦æ±‚é«˜
- æœ‰ç¨³å®šçš„HTTPSæœåŠ¡å™¨
- å¸Œæœ›å‡å°‘APIè°ƒç”¨æ¬¡æ•°
- éœ€è¦å¤„ç†å¤§é‡å¹¶å‘ç”¨æˆ·

ä¸¤ç§æ¨¡å¼å¯ä»¥éšæ—¶åˆ‡æ¢ï¼Œåªéœ€ä¿®æ”¹é…ç½®æ–‡ä»¶ä¸­çš„ `use_polling` è®¾ç½®å³å¯ã€‚
